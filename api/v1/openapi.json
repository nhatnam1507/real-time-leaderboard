{
  "components": {
    "schemas": {
      "ErrorInfo": {
        "properties": {
          "code": {
            "type": "string"
          },
          "message": {
            "type": "string"
          }
        },
        "type": "object"
      },
      "Leaderboard": {
        "properties": {
          "entries": {
            "description": "List of leaderboard entries, sorted by rank",
            "items": {
              "$ref": "#/components/schemas/LeaderboardEntry"
            },
            "type": "array"
          },
          "total": {
            "description": "Number of entries returned (equals the limit parameter when limit is applied, or the actual number of players if limit exceeds available entries)",
            "example": 50,
            "format": "int64",
            "type": "integer"
          }
        },
        "type": "object"
      },
      "LeaderboardEntry": {
        "properties": {
          "rank": {
            "description": "User's rank in the leaderboard (1-indexed)",
            "example": 1,
            "format": "int64",
            "type": "integer"
          },
          "score": {
            "description": "User's score",
            "example": 1500,
            "format": "int64",
            "type": "integer"
          },
          "user_id": {
            "description": "User identifier",
            "example": "00000000-0000-0000-0000-000000000001",
            "format": "uuid",
            "type": "string"
          },
          "username": {
            "description": "User's username",
            "example": "alice",
            "type": "string"
          }
        },
        "type": "object"
      },
      "LoginRequest": {
        "properties": {
          "password": {
            "example": "password123",
            "type": "string"
          },
          "username": {
            "example": "john_doe",
            "type": "string"
          }
        },
        "required": [
          "username",
          "password"
        ],
        "type": "object"
      },
      "RegisterRequest": {
        "properties": {
          "email": {
            "example": "john@example.com",
            "format": "email",
            "type": "string"
          },
          "password": {
            "example": "password123",
            "minLength": 6,
            "type": "string"
          },
          "username": {
            "example": "john_doe",
            "maxLength": 50,
            "minLength": 3,
            "type": "string"
          }
        },
        "required": [
          "username",
          "email",
          "password"
        ],
        "type": "object"
      },
      "Response": {
        "properties": {
          "data": {
            "additionalProperties": true,
            "type": "object"
          },
          "error": {
            "$ref": "#/components/schemas/ErrorInfo"
          },
          "message": {
            "type": "string"
          },
          "meta": {
            "additionalProperties": true,
            "type": "object"
          },
          "success": {
            "type": "boolean"
          }
        },
        "type": "object"
      },
      "SubmitScoreRequest": {
        "properties": {
          "score": {
            "example": 1000,
            "minimum": 0,
            "type": "integer"
          }
        },
        "required": [
          "score"
        ],
        "type": "object"
      }
    },
    "securitySchemes": {
      "BearerAuth": {
        "bearerFormat": "JWT",
        "scheme": "bearer",
        "type": "http"
      }
    }
  },
  "info": {
    "contact": {
      "email": "support@example.com",
      "name": "API Support",
      "url": "http://www.example.com/support"
    },
    "description": "Real-time leaderboard system with REST API for score updates and Server-Sent Events (SSE) for live leaderboard updates",
    "license": {
      "name": "Apache 2.0",
      "url": "http://www.apache.org/licenses/LICENSE-2.0.html"
    },
    "termsOfService": "http://swagger.io/terms/",
    "title": "Real-Time Leaderboard API",
    "version": "1.0"
  },
  "openapi": "3.0.3",
  "paths": {
    "/auth/login": {
      "post": {
        "description": "Authenticate user with username and password, returns JWT access and refresh tokens",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/LoginRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Response"
                }
              }
            },
            "description": "Login successful"
          },
          "401": {
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Response"
                }
              }
            },
            "description": "Invalid credentials"
          }
        },
        "summary": "Login user",
        "tags": [
          "auth"
        ]
      }
    },
    "/auth/refresh": {
      "post": {
        "description": "Refresh access token using a valid refresh token. Returns new access and refresh tokens.",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "properties": {
                  "refresh_token": {
                    "type": "string"
                  }
                },
                "required": [
                  "refresh_token"
                ],
                "type": "object"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Response"
                }
              }
            },
            "description": "Token refreshed successfully"
          },
          "401": {
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Response"
                }
              }
            },
            "description": "Invalid or expired refresh token"
          }
        },
        "summary": "Refresh access token",
        "tags": [
          "auth"
        ]
      }
    },
    "/auth/register": {
      "post": {
        "description": "Register a new user with username, email, and password. Returns user information and JWT tokens.",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RegisterRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "201": {
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Response"
                }
              }
            },
            "description": "User registered successfully"
          },
          "400": {
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Response"
                }
              }
            },
            "description": "Invalid request"
          },
          "409": {
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Response"
                }
              }
            },
            "description": "User already exists"
          }
        },
        "summary": "Register a new user",
        "tags": [
          "auth"
        ]
      }
    },
    "/leaderboard/score": {
      "put": {
        "description": "Update the score for the authenticated user. Requires authentication.\nUses UPSERT pattern - automatically creates the record if it doesn't exist, or updates if it exists.\nThe score will be saved in PostgreSQL (backup) and updated in Redis (leaderboard).\nReturns the user ID and updated score.\n",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SubmitScoreRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/Response"
                    },
                    {
                      "properties": {
                        "data": {
                          "properties": {
                            "score": {
                              "example": 1500,
                              "type": "integer"
                            },
                            "user_id": {
                              "example": "00000000-0000-0000-0000-000000000001",
                              "format": "uuid",
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      },
                      "type": "object"
                    }
                  ]
                }
              }
            },
            "description": "Score updated successfully"
          },
          "400": {
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Response"
                }
              }
            },
            "description": "Invalid request"
          },
          "401": {
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Response"
                }
              }
            },
            "description": "Unauthorized"
          }
        },
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "summary": "Update score",
        "tags": [
          "leaderboard"
        ]
      }
    },
    "/leaderboard/stream": {
      "get": {
        "description": "Server-Sent Events (SSE) stream for real-time leaderboard updates.\nReturns `text/event-stream` content type. Clients receive initial leaderboard data\nand automatic updates when scores change. Updates are pushed via Redis pub/sub\nnotifications - no polling required.\n\n**Lazy Loading**: If Redis is empty, the system automatically syncs data from PostgreSQL\non the first request, ensuring seed data and existing scores are available.\n\n**Pagination**: The `limit` parameter controls how many top players to return (default: 100, max: 100).\nThe leaderboard always shows top N players starting from rank 1 (no offset support for SSE).\n",
        "parameters": [
          {
            "description": "Number of top players to return (always starts from rank 1)",
            "in": "query",
            "name": "limit",
            "schema": {
              "default": 100,
              "example": 50,
              "maximum": 100,
              "minimum": 1,
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "content": {
              "text/event-stream": {
                "schema": {
                  "example": "data: {\"success\":true,\"data\":{\"entries\":[{\"user_id\":\"00000000-0000-0000-0000-000000000001\",\"username\":\"alice\",\"score\":1500,\"rank\":1},{\"user_id\":\"00000000-0000-0000-0000-000000000002\",\"username\":\"bob\",\"score\":1400,\"rank\":2}],\"total\":2},\"message\":\"Leaderboard retrieved successfully\"}\n\ndata: {\"success\":true,\"data\":{\"entries\":[{\"user_id\":\"00000000-0000-0000-0000-000000000001\",\"username\":\"alice\",\"score\":1600,\"rank\":1},{\"user_id\":\"00000000-0000-0000-0000-000000000002\",\"username\":\"bob\",\"score\":1400,\"rank\":2}],\"total\":2},\"message\":\"Leaderboard updated\"}\n",
                  "type": "string"
                }
              }
            },
            "description": "SSE stream with leaderboard data. Content-Type: text/event-stream.\nInitial leaderboard sent immediately, followed by updates when scores change.\nEach SSE message contains a JSON object with the standard response format.\n"
          },
          "500": {
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Response"
                }
              }
            },
            "description": "Internal server error"
          }
        },
        "summary": "Get leaderboard (SSE stream)",
        "tags": [
          "leaderboard"
        ]
      }
    }
  },
  "servers": [
    {
      "description": "API v1",
      "url": "/api/v1"
    }
  ],
  "tags": [
    {
      "description": "Authentication endpoints",
      "name": "auth"
    },
    {
      "description": "Leaderboard and score endpoints",
      "name": "leaderboard"
    }
  ],
  "x-tagGroups": [
    {
      "name": "v1",
      "tags": [
        "auth",
        "leaderboard"
      ]
    }
  ]
}