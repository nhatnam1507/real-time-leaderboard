openapi: 3.0.3
info:
  title: Real-Time Leaderboard API
  version: "1.0"
  description: Real-time leaderboard system with REST API for score updates and Server-Sent Events (SSE) for live leaderboard updates
  contact:
    name: API Support
    url: http://www.example.com/support
    email: support@example.com
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
  termsOfService: http://swagger.io/terms/

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: auth
    description: Authentication endpoints
  - name: leaderboard
    description: Leaderboard and score endpoints

x-tagGroups:
  - name: v1
    tags:
      - auth
      - leaderboard

paths:
  /auth/register:
    post:
      tags:
        - auth
      summary: Register a new user
      description: Register a new user with username, email, and password. Returns user information and JWT tokens.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
        '409':
          description: User already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'

  /auth/login:
    post:
      tags:
        - auth
      summary: Login user
      description: Authenticate user with username and password, returns JWT access and refresh tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'

  /auth/refresh:
    post:
      tags:
        - auth
      summary: Refresh access token
      description: Refresh access token using a valid refresh token. Returns new access and refresh tokens.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'

  /auth/me:
    get:
      tags:
        - auth
      summary: Get current user information
      description: Returns the current authenticated user's information based on the JWT token in the Authorization header.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User information retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'

  /leaderboard:
    get:
      tags:
        - leaderboard
      summary: Get leaderboard with pagination
      description: |
        Retrieve the leaderboard with pagination support. This endpoint is used for initial dashboard load.
        Returns a paginated list of leaderboard entries sorted by rank (highest score first).
        
        **Lazy Loading**: If Redis is empty, the system automatically syncs data from PostgreSQL
        on the first request, ensuring seed data and existing scores are available.
      parameters:
        - name: limit
          in: query
          description: Number of entries to return per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
            example: 10
        - name: offset
          in: query
          description: Number of entries to skip (for pagination)
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        '200':
          description: Leaderboard retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/LeaderboardEntry'
                        description: List of leaderboard entries, sorted by rank
                      meta:
                        $ref: '#/components/schemas/Pagination'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'

  /leaderboard/score:
    put:
      tags:
        - leaderboard
      summary: Update score
      description: |
        Update the score for the authenticated user. Requires authentication.
        Uses UPSERT pattern - automatically creates the record if it doesn't exist, or updates if it exists.
        The score will be saved in PostgreSQL (persistent storage) and updated in Redis (cache).
        
        **Broadcast Optimization**: After successful update, if the user's rank is within the top 1000,
        a leaderboard entry delta update is published to the `leaderboard:viewer:updates` topic.
        Entries ranked outside the top 1000 are not broadcasted to reduce network traffic.
        
        Returns the user ID and updated score.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitScoreRequest'
      responses:
        '200':
          description: Score updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user_id:
                            type: string
                            format: uuid
                            example: "00000000-0000-0000-0000-000000000001"
                          score:
                            type: integer
                            example: 1500
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'

  /leaderboard/stream:
    get:
      tags:
        - leaderboard
      summary: Get leaderboard delta updates (SSE stream)
      description: |
        Server-Sent Events (SSE) stream for real-time leaderboard entry delta updates.
        Returns `text/event-stream` content type. Clients receive delta updates (single entry changes)
        when scores change. Updates are pushed via Redis pub/sub notifications - no polling required.
        
        **Usage Pattern**: 
        1. Load initial leaderboard using GET /leaderboard
        2. Connect to this SSE stream to receive delta updates
        3. Merge delta updates into local leaderboard state
        4. If SSE disconnects, reload from GET /leaderboard
        
        **Lazy Loading**: If Redis is empty, the system automatically syncs data from PostgreSQL
        on the first request, ensuring seed data and existing scores are available.
        
        **Broadcast Optimization**: Only entries ranked within the top 1000 trigger broadcasts.
        Entries ranked outside this range are not sent to reduce network traffic, as they are
        unlikely to be relevant to clients viewing top N leaderboards.
      responses:
        '200':
          description: |
            SSE stream with leaderboard entry delta updates. Content-Type: text/event-stream.
            Each SSE message contains a JSON object with a single leaderboard entry.
            Clients should merge these updates into their local leaderboard state.
          content:
            text/event-stream:
              schema:
                type: string
                example: |
                  data: {"success":true,"data":{"user_id":"00000000-0000-0000-0000-000000000001","username":"alice","score":1600,"rank":1},"message":"Leaderboard entry updated"}
                  
                  data: {"success":true,"data":{"user_id":"00000000-0000-0000-0000-000000000002","username":"bob","score":1500,"rank":2},"message":"Leaderboard entry updated"}
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    RegisterRequest:
      type: object
      required:
        - username
        - email
        - password
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
          example: john_doe
        email:
          type: string
          format: email
          example: john@example.com
        password:
          type: string
          minLength: 6
          example: password123

    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: john_doe
        password:
          type: string
          example: password123

    SubmitScoreRequest:
      type: object
      required:
        - score
      properties:
        score:
          type: integer
          minimum: 0
          example: 1000

    Response:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          additionalProperties: true
        error:
          $ref: '#/components/schemas/ErrorInfo'
        meta:
          type: object
          additionalProperties: true

    ErrorInfo:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: User identifier
          example: "00000000-0000-0000-0000-000000000001"
        username:
          type: string
          description: User's username
          example: "john_doe"
        email:
          type: string
          format: email
          description: User's email address
          example: "john@example.com"
        created_at:
          type: string
          format: date-time
          description: User creation timestamp
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: User last update timestamp
          example: "2024-01-01T00:00:00Z"
    LeaderboardEntry:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
          description: User identifier
          example: "00000000-0000-0000-0000-000000000001"
        username:
          type: string
          description: User's username
          example: "alice"
        score:
          type: integer
          format: int64
          description: User's score
          example: 1500
        rank:
          type: integer
          format: int64
          description: User's rank in the leaderboard (1-indexed)
          example: 1

    Pagination:
      type: object
      properties:
        page:
          type: integer
          description: Current page number (1-indexed)
          example: 1
        limit:
          type: integer
          description: Number of items per page
          example: 10
        total:
          type: integer
          format: int64
          description: Total number of items
          example: 50
        total_pages:
          type: integer
          description: Total number of pages
          example: 5

